name = "mail-app-worker"
main = "workers/api/index.js"
compatibility_date = "2024-10-22"
compatibility_flags = ["nodejs_compat"]

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "maildb"
database_id = "8f96a820-872b-42e9-bf7d-a5ae41aa4b7c"

# R2 Bucket
[[r2_buckets]]
binding = "MAILSTORE"
bucket_name = "mailstore"

# Durable Object (Owns the Class)
[[durable_objects.bindings]]
name = "REALTIME_HUB"
class_name = "RealtimeHub"
script_name = "mail-app-worker"

[[migrations]]
tag = "v1"
new_classes = ["RealtimeHub"]

[[services]]
binding = "TODOIST_WORKER"
service = "mail-app-todoist"

# Vars
[vars]
SEND_FROM_EMAIL = "hello@infinitywave.design"
TAG_LABELS = "Marketing, Recruitment, Personal, Finance, Support, Other"
# Push notifications via ntfy (https://ntfy.sh)
# NTFY_TOPIC = "my-email-inbox"
# NOTIFY_APP_URL = "https://mail.infinitywave.design"

# Routes
[env.production]
name = "mail-app-worker"
routes = [
  { pattern = "api.infinitywave.design", custom_domain = true },
  { pattern = "mail.infinitywave.design", custom_domain = true }
]

[[env.production.durable_objects.bindings]]
name = "REALTIME_HUB"
class_name = "RealtimeHub"
script_name = "mail-app-worker"

[[env.production.services]]
binding = "TODOIST_WORKER"
service = "mail-app-todoist"

[env.production.vars]
OPENROUTER_MODEL = "google/gemini-2.0-flash-lite-001"
SEND_FROM_EMAIL = "hello@infinitywave.design"
SENTRY_DSN = "https://d29d6d205377084a3fa87aa4ba4d091b@o4510748410576896.ingest.de.sentry.io/4510748412346448"

[[env.production.d1_databases]]
binding = "DB"
database_name = "maildb"
database_id = "8f96a820-872b-42e9-bf7d-a5ae41aa4b7c"

[[env.production.r2_buckets]]
binding = "MAILSTORE"
bucket_name = "mailstore"

# Static Assets
[assets]
directory = "./web/dist"

# Observability
[observability]
enabled = true
head_sampling_rate = 1

[observability.logs]
enabled = true
invocation_logs = true

[observability.traces]
enabled = true


# Development
[env.dev]
name = "mail-app-worker-dev"

[[env.dev.services]]
binding = "TODOIST_WORKER"
service = "mail-app-todoist-dev"

[[env.dev.d1_databases]]
binding = "DB"
database_name = "maildb-dev"
database_id = "placeholder-dev"

[[env.dev.r2_buckets]]
binding = "MAILSTORE"
bucket_name = "mailstore-dev"
