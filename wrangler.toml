name = "mail-app-worker"
main = "src/worker.js"
compatibility_date = "2024-01-01"

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "maildb"
database_id = "13ae0605-ffca-426d-b3ca-e682b296de0f"

# NOTE: R2 must be enabled in Cloudflare Dashboard first
# Go to R2 in dashboard, enable it, then create bucket
# [[r2_buckets]]
# binding = "MAILSTORE"
# bucket_name = "mailstore"

# NOTE: Queues require Cloudflare Workers Paid plan ($5/mo)
# Uncomment below when ready to enable async spam classification
# [[queues.producers]]
# binding = "MAIL_EVENTS"
# queue = "mail-events"
#
# [[queues.consumers]]
# queue = "mail-events"
# max_batch_size = 10
# max_batch_timeout = 30

# Durable Object
[[durable_objects.bindings]]
name = "REALTIME_HUB"
class_name = "RealtimeHub"
script_name = "mail-app-worker"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["RealtimeHub"]

# Environment Variables
[vars]
OPENAI_MODEL = "gpt-4o-mini"

# Secrets (set via: wrangler secret put <NAME>)
# API_TOKEN - required for API authentication
# OPENAI_API_KEY - required for spam classification

# Routes for email handling
[email]
# Email routing will be configured in Cloudflare dashboard
# to route to this worker

# Development
[env.dev]
name = "mail-app-worker-dev"

[env.dev.vars]
OPENAI_MODEL = "gpt-4o-mini"

[[env.dev.d1_databases]]
binding = "DB"
database_name = "maildb-dev"
database_id = "placeholder-dev"

[[env.dev.r2_buckets]]
binding = "MAILSTORE"
bucket_name = "mailstore-dev"

# Production
[env.production]
name = "mail-app-worker"

[env.production.vars]
OPENAI_MODEL = "gpt-4o-mini"

[[env.production.d1_databases]]
binding = "DB"
database_name = "maildb"
database_id = "13ae0605-ffca-426d-b3ca-e682b296de0f"

# NOTE: R2 must be enabled first
# [[env.production.r2_buckets]]
# binding = "MAILSTORE"
# bucket_name = "mailstore"

# NOTE: Queues require paid plan - commented out
# [[env.production.queues.producers]]
# binding = "MAIL_EVENTS"
# queue = "mail-events"
#
# [[env.production.queues.consumers]]
# queue = "mail-events"
# max_batch_size = 10
# max_batch_timeout = 30

[[env.production.durable_objects.bindings]]
name = "REALTIME_HUB"
class_name = "RealtimeHub"
script_name = "mail-app-worker"
